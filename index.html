<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyMed Routine</title>
    <!-- Incluir Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Animação para o LED pulsante */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Toast Notification Styling */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
            font-weight: 500;
        }
        #toast-notification.show {
            opacity: 1;
        }
        #toast-notification.success {
            background-color: #22c55e; /* green-500 */
        }
        #toast-notification.error {
            background-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800 flex flex-col items-center p-4 md:p-8">

    <div class="w-full max-w-4xl flex flex-col items-center">
        <header class="w-full text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-600 mb-2">MyMed Routine</h1>
            <p class="text-xl text-gray-600">Organize sua rotina de medicamentos, por dia e por semana.</p>
            <div id="user-info" class="text-center text-sm text-gray-500 mb-4">
                <p>ID do Usuário: <span id="user-id-display" class="font-mono text-gray-700 break-all">Carregando...</span></p>
                <button id="logout-button" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-full text-xs hidden">Sair</button>
            </div>
        </header>

        <div class="w-full mb-6">
            <div id="tabs" class="flex w-full overflow-x-auto">
                <button id="daily-tab" class="flex-1 min-w-[100px] text-gray-700 font-bold py-2 px-4 border-b-2 transition-all duration-300 bg-blue-500 text-white border-blue-500 rounded-tl-lg">Hoje</button>
                <button id="weekly-tab" class="flex-1 min-w-[100px] text-gray-700 font-bold py-2 px-4 border-b-2 transition-all duration-300 bg-transparent text-gray-700 border-transparent hover:border-gray-300 rounded-tr-lg">Semana</button>
            </div>
        </div>

        <main id="main-content" class="w-full">
            <!-- Conteúdo será carregado aqui pelo JavaScript -->
        </main>

        <footer class="mt-8 w-full max-w-lg">
            <button id="add-medicine-button" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 flex items-center justify-center space-x-2 rounded-full px-6 py-3 font-semibold text-white transition-all duration-300 transform hover:scale-105 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19" /><line x1="5" x2="19" y1="12" y2="12" /></svg>
                <span>Adicionar Remédio</span>
            </button>
        </footer>

        <!-- Modal para Adicionar Remédio -->
        <div id="add-medicine-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-all duration-300 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-lg mx-4 transform transition-all duration-300 scale-95">
                <h3 class="text-2xl font-bold mb-4">Adicionar Novo Remédio</h3>
                <form id="add-medicine-form" class="flex flex-col gap-4">
                    <div class="flex flex-col">
                        <label for="medicine-name" class="block text-sm font-medium text-gray-700">Nome do Remédio</label>
                        <input type="text" id="medicine-name" class="w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" placeholder="Ex: Vitamina C" required />
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-sm font-medium text-gray-700">Horários</label>
                        <div id="times-container">
                            <!-- Horários serão adicionados aqui pelo JavaScript -->
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="time" class="time-input w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" value="09:00" required />
                            </div>
                        </div>
                        <button type="button" id="add-time-button" class="bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400 rounded-full px-6 py-3 font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95">
                            Adicionar Horário
                        </button>
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-sm font-medium text-gray-700">Dias da Semana</label>
                        <div id="days-checkbox-container" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                            <!-- Checkboxes dos dias serão adicionados aqui pelo JavaScript -->
                        </div>
                    </div>
                    <button type="submit" id="save-medicine-button" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 mt-4 rounded-full px-6 py-3 font-semibold text-white transition-all duration-300 transform hover:scale-105 active:scale-95">Salvar Remédio</button>
                </form>
                <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>

        <!-- Modal de Login/Registo -->
        <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-all duration-300 opacity-0 pointer-events-none">
            <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-lg mx-4 transform transition-all duration-300 scale-95">
                <h3 class="text-2xl font-bold mb-4 text-center" id="auth-modal-title">Iniciar Sessão</h3>
                <form id="auth-form" class="flex flex-col gap-4">
                    <div class="flex flex-col">
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="auth-email" class="w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" placeholder="seuemail@exemplo.com" required />
                    </div>
                    <div class="flex flex-col">
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                        <input type="password" id="auth-password" class="w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" placeholder="Mínimo 6 caracteres" required />
                    </div>
                    <button type="submit" id="auth-submit-button" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 mt-4 rounded-full px-6 py-3 font-semibold text-white transition-all duration-300 transform hover:scale-105 active:scale-95">Entrar</button>
                    <button type="button" id="toggle-auth-mode-button" class="w-full text-blue-500 hover:text-blue-600 mt-2 font-semibold">Não tem uma conta? Crie uma!</button>
                </form>
                <button id="close-auth-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>

        <!-- Toast Notification Element -->
        <div id="toast-notification" class="hidden"></div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and application state
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let medicines = [];
        let view = 'daily'; // 'daily' or 'weekly'
        let activeAlarmId = null; // ID of the medicine with an active alarm
        let isLoading = false; // Global loading state
        let authMode = 'login'; // 'login' or 'signup'

        // Array of weekdays for mapping
        const daysOfWeek = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];

        // Canvas environment constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCkFFWTZf6TRxCcdX8e9u3ht7rBrK0U1gY",
            authDomain: "rotina-de-remedios-a25aa.firebaseapp.com",
            projectId: "rotina-de-remedios-a25aa",
            storageBucket: "rotina-de-remedios-a25aa.firebasestorage.app",
            messagingSenderId: "776904181981",
            appId: "1:776904181981:web:f7346dd93e9c13857b7334",
            measurementId: "G-913Q465M96"
        };

        // Utility functions for TTS
        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);

            view.setUint32(0, 0x46464952, true); // RIFF identifier
            view.setUint32(4, 36 + pcmData.length * 2, true); // file size
            view.setUint32(8, 0x45564157, true); // RIFF format
            view.setUint32(12, 0x20746d66, true); // fmt chunk identifier
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, 1, true); // Number of channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, sampleRate * 2, true); // Byte rate
            view.setUint16(32, 2, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample
            view.setUint32(36, 0x61746164, true); // data chunk identifier
            view.setUint32(40, pcmData.length * 2, true); // data chunk size

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const playTtsAudio = async (text, voiceName = "Zephyr") => {
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: voiceName }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = ""; // Canvas will provide this in runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                const audioPart = result?.candidates?.[0]?.content?.parts?.[0];

                if (audioPart && audioPart.inlineData) {
                    const audioData = audioPart.inlineData.data;
                    const mimeType = audioPart.inlineData.mimeType;

                    if (mimeType.startsWith("audio/L16")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        const audio = new Audio(audioUrl);
                        audio.play().catch(e => console.error("Erro ao tocar áudio:", e));
                    } else {
                        console.error("Formato de áudio não suportado:", mimeType);
                        showToast('Erro: Formato de áudio não suportado.', 'error');
                    }
                } else {
                    console.error("Nenhum dado de áudio encontrado na resposta.");
                    showToast('Erro: Nenhum áudio gerado.', 'error');
                }
            } catch (error) {
                console.error("Erro ao gerar ou tocar áudio TTS:", error);
                showToast('Erro ao gerar áudio TTS.', 'error');
            }
        };

        // UI Rendering Functions
        const renderDailyView = () => {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="flex flex-col gap-4">
                    <h2 class="text-2xl font-bold text-center">Rotina de Hoje (${daysOfWeek[new Date().getDay()]})</h2>
                    <div id="daily-medicines-list" class="flex flex-col gap-4"></div>
                </div>
            `;
            const dailyMedicinesList = document.getElementById('daily-medicines-list');
            const today = daysOfWeek[new Date().getDay()];
            const todayMedicines = medicines
                .filter(med => med.days.includes(today))
                .sort((a, b) => {
                    const timeA = a.times && a.times.length > 0 ? a.times[0] : '23:59';
                    const timeB = b.times && b.times.length > 0 ? b.times[0] : '23:59';
                    return timeA.localeCompare(timeB);
                });

            if (todayMedicines.length > 0) {
                todayMedicines.forEach(med => {
                    const isTaken = isTakenToday(med);
                    const card = document.createElement('div');
                    card.className = `rounded-xl bg-white p-6 shadow-md transition-all duration-300 relative flex items-center justify-between`;
                    card.innerHTML = `
                        <div class="flex items-center space-x-4 flex-grow">
                            <div class="flex-shrink-0">
                                ${activeAlarmId === med.id ? `
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="text-red-500 animate-pulse"><path d="M6 8a6 6 0 0 1 12 0v15l-6-3-6 3V8z" /><path d="M12 3a3 3 0 0 0 -3 3v2a3 3 0 0 0 6 0V6a3 3 0 0 0 -3 -3" /></svg>
                                </div>
                                ` : `
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 rounded-full ${isTaken ? 'bg-green-500' : 'bg-gray-400'}"></div>
                                </div>
                                `}
                            </div>
                            <div class="flex-grow">
                                <div class="text-lg font-semibold">${med.name}</div>
                                <div class="text-sm text-gray-500">Horário: ${med.times.join(', ')}</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            ${isTaken ? `
                                <div class="text-green-500 font-semibold text-sm">Tomado!</div>
                            ` : `
                                <button class="toggle-taken-button bg-green-500 hover:bg-green-600 active:bg-green-700 rounded-full p-2 text-white transition-all duration-300 transform hover:scale-105 active:scale-95" data-med-id="${med.id}" ${isLoading ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>
                                </button>
                            `}
                            <button class="delete-medicine-button bg-red-500 hover:bg-red-600 active:bg-red-700 rounded-full p-2 text-white transition-all duration-300 transform hover:scale-105 active:scale-95" data-med-id="${med.id}" ${isLoading ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>
                            </button>
                        </div>
                    `;
                    dailyMedicinesList.appendChild(card);
                });

                // Add listeners for "Taken" and "Delete" buttons
                dailyMedicinesList.querySelectorAll('.toggle-taken-button').forEach(button => {
                    button.addEventListener('click', (e) => handleToggleTaken(e.currentTarget.dataset.medId));
                });
                dailyMedicinesList.querySelectorAll('.delete-medicine-button').forEach(button => {
                    button.addEventListener('click', (e) => handleDeleteMedicine(e.currentTarget.dataset.medId));
                });

            } else {
                dailyMedicinesList.innerHTML = `<p class="text-center text-gray-500">Nenhum remédio agendado para hoje. Adicione um novo para começar!</p>`;
            }
        };

        const renderWeeklyView = () => {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="flex flex-col gap-4">
                    <h2 class="text-2xl font-bold text-center">Visão Semanal</h2>
                    <div id="weekly-medicines-list" class="flex flex-col gap-4"></div>
                </div>
            `;
            const weeklyMedicinesList = document.getElementById('weekly-medicines-list');

            if (medicines.length > 0) {
                medicines.forEach(med => {
                    const card = document.createElement('div');
                    card.className = `rounded-xl bg-white p-6 shadow-md transition-all duration-300`;
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-lg font-semibold">${med.name}</div>
                            <button class="delete-medicine-button bg-red-500 hover:bg-red-600 active:bg-red-700 rounded-full p-2 text-white transition-all duration-300 transform hover:scale-105 active:scale-95" data-med-id="${med.id}" ${isLoading ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">Horários: ${med.times.join(', ')}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            Dias: ${med.days.length === 7 ? 'Todos os dias' : med.days.join(', ')}
                        </div>
                        <div class="text-sm text-gray-600">
                            Última dose tomada: ${med.takenTimestamps && med.takenTimestamps.length > 0
                                ? new Date(med.takenTimestamps[med.takenTimestamps.length - 1]).toLocaleString('pt-BR')
                                : 'Nenhuma dose registrada.'}
                        </div>
                    `;
                    weeklyMedicinesList.appendChild(card);
                });
                // Add listeners for "Delete" buttons
                weeklyMedicinesList.querySelectorAll('.delete-medicine-button').forEach(button => {
                    button.addEventListener('click', (e) => handleDeleteMedicine(e.currentTarget.dataset.medId));
                });
            } else {
                weeklyMedicinesList.innerHTML = `<p class="text-center text-gray-500">Nenhum remédio na sua agenda. Adicione um novo para começar!</p>`;
            }
        };

        const renderUI = () => {
            document.getElementById('user-id-display').textContent = userId || 'Não autenticado';
            const logoutButton = document.getElementById('logout-button');
            if (userId) {
                logoutButton.classList.remove('hidden');
            } else {
                logoutButton.classList.add('hidden');
            }

            if (view === 'daily') {
                renderDailyView();
            } else {
                renderWeeklyView();
            }

            // Update tab classes
            document.getElementById('daily-tab').className = `flex-1 min-w-[100px] text-gray-700 font-bold py-2 px-4 border-b-2 transition-all duration-300 ${view === 'daily' ? 'bg-blue-500 text-white border-blue-500' : 'bg-transparent text-gray-700 border-transparent hover:border-gray-300'} rounded-tl-lg`;
            document.getElementById('weekly-tab').className = `flex-1 min-w-[100px] text-gray-700 font-bold py-2 px-4 border-b-2 transition-all duration-300 ${view === 'weekly' ? 'bg-blue-500 text-white border-blue-500' : 'bg-transparent text-gray-700 border-transparent hover:border-gray-300'} rounded-tr-lg`;
        };

        const isTakenToday = (med) => {
            const todayDateString = new Date().toDateString();
            return med.takenTimestamps && med.takenTimestamps.some(t => new Date(t).toDateString() === todayDateString);
        };

        // Toast Notification System
        let toastTimeout;
        const showToast = (message, type = 'info') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `show ${type}`; // Add type class for styling
            toast.classList.remove('hidden');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                // Hide after animation
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        };

        // Loading state management
        const setLoading = (state) => {
            isLoading = state;
            // Disable/enable main action buttons
            document.getElementById('add-medicine-button').disabled = state;
            document.getElementById('save-medicine-button').disabled = state;
            document.getElementById('auth-submit-button').disabled = state;


            // Also disable buttons within the rendered medicine cards
            document.querySelectorAll('.toggle-taken-button, .delete-medicine-button').forEach(button => {
                button.disabled = state;
            });

            // You could also add a visual loading indicator here if needed
        };


        // Add medicine modal management
        const showAddModal = () => {
            if (!userId) {
                showToast('Por favor, faça login para adicionar remédios.', 'info');
                return;
            }
            const modal = document.getElementById('add-medicine-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.bg-white').classList.remove('scale-95');
            modal.querySelector('.bg-white').classList.add('scale-100');

            // Reset form
            document.getElementById('medicine-name').value = '';
            const timesContainer = document.getElementById('times-container');
            timesContainer.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <input type="time" class="time-input w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" value="09:00" required />
                </div>
            `;
            attachTimeInputListeners();

            const daysCheckboxContainer = document.getElementById('days-checkbox-container');
            daysCheckboxContainer.innerHTML = '';
            daysOfWeek.forEach((day, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center space-x-2';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="day-${day}" class="day-checkbox h-4 w-4 rounded text-blue-600 focus:ring-blue-500" ${index === new Date().getDay() ? 'checked' : ''} />
                    <label for="day-${day}" class="text-gray-900">${day}</label>
                `;
                daysCheckboxContainer.appendChild(checkboxDiv);
            });
        };

        const hideAddModal = () => {
            const modal = document.getElementById('add-medicine-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.bg-white').classList.add('scale-95');
            modal.querySelector('.bg-white').classList.remove('scale-100');
        };

        const attachTimeInputListeners = () => {
            const removeButtons = document.querySelectorAll('.remove-time-button');
            removeButtons.forEach(button => {
                button.onclick = (e) => removeTimeInput(e.currentTarget.parentNode);
            });
        };

        const addTimeInput = () => {
            const timesContainer = document.getElementById('times-container');
            const newTimeDiv = document.createElement('div');
            newTimeDiv.className = 'flex items-center space-x-2 mb-2';
            newTimeDiv.innerHTML = `
                <input type="time" class="time-input w-full rounded-md border border-gray-300 px-4 py-2 focus:border-blue-500 focus:outline-none transition-all duration-300" value="" required />
                <button type="button" class="remove-time-button bg-gray-300 hover:bg-gray-400 text-gray-800 p-2 rounded-full text-sm font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>
                </button>
            `;
            timesContainer.appendChild(newTimeDiv);
            attachTimeInputListeners(); // Re-attach listeners after adding new input
        };

        const removeTimeInput = (element) => {
            element.remove();
        };

        // Firestore Event Handlers
        const handleAddMedicine = async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                showToast('Por favor, faça login para adicionar remédios.', 'error');
                return;
            }

            setLoading(true);

            const name = document.getElementById('medicine-name').value.trim();
            const times = Array.from(document.querySelectorAll('.time-input'))
                                     .map(input => input.value.trim())
                                     .filter(t => t !== '');
            const days = Array.from(document.querySelectorAll('.day-checkbox:checked'))
                                     .map(checkbox => document.querySelector(`label[for="${checkbox.id}"]`).textContent);

            if (!name || !times.length || !days.length) {
                showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                setLoading(false);
                return;
            }

            try {
                const docRef = doc(collection(db, `artifacts/${appId}/users/${userId}/medication_schedule`));
                await setDoc(docRef, {
                    name: name,
                    times: times,
                    days: days,
                    takenTimestamps: []
                });
                hideAddModal();
                showToast('Remédio adicionado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao adicionar documento: ", error);
                showToast('Erro ao adicionar remédio. Tente novamente.', 'error');
            } finally {
                setLoading(false);
            }
        };

        const handleToggleTaken = async (medId) => {
            if (!db || !userId) {
                showToast('Por favor, faça login para registar as doses.', 'error');
                return;
            }

            setLoading(true);

            try {
                const medDocRef = doc(db, `artifacts/${appId}/users/${userId}/medication_schedule`, medId);
                const medicine = medicines.find(m => m.id === medId);
                if (!medicine) {
                    showToast('Remédio não encontrado.', 'error');
                    setLoading(false);
                    return;
                }

                const updatedTimestamps = [...(medicine.takenTimestamps || []), new Date().toISOString()];
                await setDoc(medDocRef, { takenTimestamps: updatedTimestamps }, { merge: true });

                if (activeAlarmId === medId) {
                    activeAlarmId = null; // Clear active alarm
                }
                showToast('Remédio marcado como tomado!', 'success');
            } catch (error) {
                console.error("Erro ao atualizar o estado do remédio: ", error);
                showToast('Erro ao marcar remédio. Tente novamente.', 'error');
            } finally {
                setLoading(false);
            }
        };

        const handleDeleteMedicine = async (medId) => {
            if (!db || !userId) {
                showToast('Por favor, faça login para excluir remédios.', 'error');
                return;
            }
            setLoading(true);

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/medication_schedule`, medId));
                showToast('Remédio excluído com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao excluir documento: ", error);
                showToast('Erro ao excluir remédio. Tente novamente.', 'error');
            } finally {
                setLoading(false);
            }
        };

        // Authentication Modal Functions
        const showAuthModal = () => {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.bg-white').classList.remove('scale-95');
            modal.querySelector('.bg-white').classList.add('scale-100');
            updateAuthModalUI();
        };

        const hideAuthModal = () => {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.bg-white').classList.add('scale-95');
            modal.querySelector('.bg-white').classList.remove('scale-100');
        };

        const toggleAuthMode = () => {
            authMode = authMode === 'login' ? 'signup' : 'login';
            updateAuthModalUI();
        };

        const updateAuthModalUI = () => {
            document.getElementById('auth-modal-title').textContent = authMode === 'login' ? 'Iniciar Sessão' : 'Criar Conta';
            document.getElementById('auth-submit-button').textContent = authMode === 'login' ? 'Entrar' : 'Criar Conta';
            document.getElementById('toggle-auth-mode-button').textContent = authMode === 'login' ? 'Não tem uma conta? Crie uma!' : 'Já tem uma conta? Inicie sessão!';
            document.getElementById('auth-password').value = ''; // Clear password on mode switch
        };

        const handleAuthSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);

            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();

            if (!email || !password) {
                showToast('Por favor, preencha o email e a palavra-passe.', 'error');
                setLoading(false);
                return;
            }

            try {
                if (authMode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showToast('Conta criada com sucesso! Faça login.', 'success');
                    authMode = 'login'; // Switch to login after signup
                    updateAuthModalUI();
                } else { // login
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('Login bem-sucedido!', 'success');
                    hideAuthModal(); // Close modal on successful login
                }
            } catch (error) {
                console.error("Erro de autenticação: ", error);
                let errorMessage = 'Erro de autenticação. Tente novamente.';
                if (error.code === 'auth/weak-password') {
                    errorMessage = 'A palavra-passe deve ter pelo menos 6 caracteres.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email já está em uso.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'O formato do email é inválido.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email ou palavra-passe incorretos.';
                }
                showToast(errorMessage, 'error');
            } finally {
                setLoading(false);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                showToast('Sessão terminada com sucesso!', 'info');
                // Clear medicines and UI after logout
                medicines = [];
                userId = null;
                renderUI();
                showAuthModal(); // Show login/signup modal after logout
            } catch (error) {
                console.error("Erro ao terminar sessão:", error);
                showToast('Erro ao terminar sessão. Tente novamente.', 'error');
            }
        };


        // Firebase Initialization and State Listeners
        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase inicializado.");

                onAuthStateChanged(auth, async (user) => {
                    console.log("Estado de autenticação alterado. Usuário:", user);
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        hideAuthModal(); // Hide auth modal if user is logged in
                    } else {
                        userId = null; // No user logged in
                        console.log("Nenhum usuário logado.");
                        showAuthModal(); // Show auth modal if no user
                    }
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = userId || 'Não autenticado';
                    renderUI(); // Initial UI render after authentication
                    setupFirestoreListener(); // Setup Firestore listener

                    // Proactively request notification permission
                    if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                showToast('As notificações de remédios estão ativadas!', 'success');
                            } else {
                                showToast('As notificações de remédios estão desativadas.', 'info');
                            }
                        });
                    }
                });
            } catch (e) {
                console.error("Erro ao inicializar Firebase ou autenticar:", e);
                showToast('Erro ao iniciar o aplicativo.', 'error');
            }

            // Configure listeners for tab buttons
            document.getElementById('daily-tab').addEventListener('click', () => { view = 'daily'; renderUI(); });
            document.getElementById('weekly-tab').addEventListener('click', () => { view = 'weekly'; renderUI(); });
            document.getElementById('add-medicine-button').addEventListener('click', showAddModal);
            document.getElementById('close-modal-button').addEventListener('click', hideAddModal);
            document.getElementById('add-medicine-form').addEventListener('submit', handleAddMedicine);
            document.getElementById('add-time-button').addEventListener('click', addTimeInput);
            document.getElementById('logout-button').addEventListener('click', handleLogout); // New logout listener

            // Authentication modal listeners
            document.getElementById('close-auth-modal-button').addEventListener('click', hideAuthModal);
            document.getElementById('toggle-auth-mode-button').addEventListener('click', toggleAuthMode);
            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);

            // Start alarm interval
            setInterval(() => {
                if (!isAuthReady || !userId) return; // Only run alarms if authenticated

                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const currentDay = daysOfWeek[now.getDay()];

                medicines.forEach(med => {
                    if (med.days.includes(currentDay) && med.times.includes(currentTime)) {
                        const hasBeenTaken = med.takenTimestamps && med.takenTimestamps.some(t => {
                            const takenDate = new Date(t);
                            return takenDate.toDateString() === now.toDateString() && `${String(takenDate.getHours()).padStart(2, '0')}:${String(takenDate.getMinutes()).padStart(2, '0')}` === currentTime;
                        });

                        if (!hasBeenTaken && activeAlarmId !== med.id) {
                            activeAlarmId = med.id;
                            playTtsAudio(`É hora de tomar seu remédio, ${med.name}.`);

                            if (Notification.permission === 'granted') {
                                new Notification('Lembrete de Remédio', {
                                    body: `É hora de tomar ${med.name}!`,
                                });
                            }
                            renderUI(); // Update UI to show active alarm
                        }
                    }
                });
            }, 60000); // Checks every minute
        };

        const setupFirestoreListener = () => {
            // Only set up Firestore listener if a valid userId is available and auth is ready.
            if (db && isAuthReady && userId) {
                try {
                    const medicineCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/medication_schedule`);
                    onSnapshot(medicineCollectionRef, (snapshot) => {
                        medicines = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        renderUI(); // Re-render UI whenever data changes
                    }, (error) => {
                        console.error("Erro ao ouvir a coleção de medicamentos:", error);
                        showToast('Erro ao carregar seus remédios. Verifique as permissões do Firebase.', 'error');
                        // Clear medicines if permissions are an issue
                        medicines = [];
                        renderUI();
                    });
                } catch (e) {
                    console.error("Erro ao configurar listener de dados:", e);
                    showToast('Erro ao configurar a sincronização de dados. Verifique as permissões do Firebase.', 'error');
                    medicines = [];
                    renderUI();
                }
            } else if (isAuthReady && !userId) {
                 console.log("Firestore listener não configurado: Nenhum utilizador logado.");
                 medicines = []; // Clear medicines if no user is logged in
                 renderUI();
            } else {
                console.log("Firestore listener não configurado: DB ou Auth não estão prontos.");
            }
        };
    </script>
</body>
</html>
